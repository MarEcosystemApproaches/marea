---
title: "Fisheries Science Advisory Report four plot example"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    theme: cerulean
vignette: >
  %\VignetteIndexEntry{Plotting ea_data in marea}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Using `marea` to develop four plots for Fisheries Science Advisory Reporting (FSAR)

```{r setup, echo = FALSE, warnings = FALSE, message = FALSE}
library(tidyverse)
library(readr)
library(marea)
library(here)
library(patchwork)
```

## Introduction

Fisheries Science Advisory Reports ([FSAR](https://www.dfo-mpo.gc.ca/science/species-especes/fisheries-halieutiques/stockassessment-evaluationstock/index-eng.html)) are provided through the Canadian Science Advisory Secretariat and help decision makers understand information about a particular fish stock through stock assessments. 

Stock assessments are the scientific process of analyzing available data to evaluate the abundance, productivity, and options for harvest levels of fish stocks in the past, present, and future.


## Example of FSAR dataset

```{r}
# data_dir <- 'R:/Science/BIODataSvc/SRC/marea'
# fsar_fourplot_exdata<- file.path(data_dir, "fsar_fourplot_exdata.csv")
# fsar_fourplot_exdata <- read_csv(fsar_fourplot_exdata)

# use an existing .Rdata file
load(here::here("data-raw", "fsar-example", "fsar_fourplot_exdata.Rdata"))
```

## Create `ea_data` from loaded data including metadata

Using **ea_data** allows for storage of rich metadata alongside the timeseries dataset. 

```{r}
fsar_example<-ea_data(
  data=fsar_fourplot_exdata,
  value_col="value",
  data_type= "stock",
  location_descriptor = "NAFO divisions",
  region = "Maritimes",
  units="variable",
  source_citation = "DFO FSAR 2025 citation",
  notes = "any caveats in this dataset"
  )
```

## Make individual plots

Individual plots can easily be constructed using `marea` plotting functions with varying style arguments. You can use @ operator to access the `ea_data` data slot and filter data using $ operator. This can be easily embedded in the plot function. Since the plots are `ggplot2` objects, extra layers can be added to customize the plots.

```{r}
# Fishing mortality
pF<-plot(fsar_example[
  fsar_example@data$panel.category=="Fishing" & fsar_example@data$ts.name=="Ut"
], style="ribbon") +
  labs(title="Fishing Mortality", y="Mortality (1/yr)", subtitle="")

# Biomass with additional Reference Points
pbiomass<-plot(fsar_example[
  fsar_example@data$panel.category=="Biomass" & fsar_example@data$ts.name=="Survey"
], style="ribbon") +
  labs(title="Biomass", y="Biomass (kt)", subtitle="") +
  geom_hline (yintercept=10.5, color="red", linetype="dashed") +
  geom_hline (yintercept=22, color="green", linetype="dashed") 

# Catches
pcatch<-plot(fsar_example[
  fsar_example@data$panel.category=="Catch" & fsar_example@data$ts.name=="CanadaTotal"
]) +
  labs(title="Fish NAFO div", y="Catch (t)", subtitle="")

# Recruitment
pabun<-plot(fsar_example[
  fsar_example@data$panel.category=="Recruitment" & fsar_example@data$ts.name=="RVpred"
], style="ribbon") +
  labs(title="RV Survey (modeled)", y="Abundance (millions)", subtitle="")

```

# Use `patchwork` to easily combine plots

It is easy to make a four plot commonly used in FSARs

```{r}
# (pcatch+ pbiomass)/(pF + pabun)
```

*Output:*
<img src="man/figures/four_plot_example.png" width="70%" />


## Learn More

- The main [README](../README.html) has a quick start

---

## Citing `marea`

Please cite the package in your work. For citation text:

```{r}
citation("marea")
```

---

*This vignette was generated using the `marea` source code (2025-10-09).*

---